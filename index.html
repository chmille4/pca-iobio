<!DOCTYPE html>
<html>
<head>
   <script src="js/alignments.js"></script>
   <script src="js/population.js"></script>
   <script src="js/region.js"></script>
   <script src="js/underscore-min.js"> </script>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
   <script type="text/javascript" src="js/loopj-jquery-tokeninput/src/jquery.tokeninput.js"></script>
   <script src="./js/d3.v3.min.js"></script>
   <script src="/socket.io/lib/socket.io.js"></script>
   <script src="./js/modernizr-custom.js"></script>
   <link rel="stylesheet" href="css/popTree.css" type="text/css" />
    <script type="text/javascript" src="js/popTree.js"></script>
   <link rel="stylesheet" href="js/loopj-jquery-tokeninput/styles/token-input.css" type="text/css" />
   <link rel="stylesheet" href="js/loopj-jquery-tokeninput/styles/token-input-custom.css" type="text/css" />
   <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
   <style>
      body {
         font-family: quicksand;
         margin: 0px;
         padding: 0px;
      }
      
      #title {
         position: absolute;
         font-weight: 300;
         font-size: 65px;
         width: 200px;
         top:10px;
         left: 10px;
         margin-bottom: 10px;
      }
      
      div.tooltip {   
        position: absolute;           
        text-align: center;           
/*        width: 100px;                  
        height: 15px;                 */
        color:white;
        padding: 4px 6px 4px 6px;             
        font: 11px arial;        
        background: rgb(80,80,80);   
        border: 0px;      
        border-radius: 4px;           
        pointer-events: none;         
      }

      #title #subtitle {
         font-size:15.4px;
/*         font-family: arial;*/
         font-weight: 400;
         margin-top:-5px;
         color:#2d8fc1;
         margin-left:5px;
      }
      
      .nt-range {
         border-radius: 3px;
         border: 1px solid rgb(170,170,170);
      }
      
      .step h1 {
         font: 50px quicksand;  
         margin: 0px;  
         cursor: pointer;     
      }
      
      .step .sub-step {
         font-size: 18px;
         margin-bottom: 15px;
         margin-top: 15px;
         margin-left: 20px;
      }
      
      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }
      
/*      .bar rect {
        shape-rendering: crispEdges;
      }*/
      

      .dot {
        fill-opacity: 0.4;
      }
      
      #graph-container {
         position: absolute;
         top: 45px;
         left: 0px;
         right: 0px;
         bottom: 0px;
/*         margin-top: 50px;
         margin-left:auto;
         margin-right:auto;
         width: 100%;
         height: 80%;*/
      }
      
      #vcf-graph {
         height:100%;
      }
      
   </style>
   
   <script type="text/javascript">
      // Set up the yepnope (Modernizr.load) directives... 
      Modernizr.load([
      {
          // Test if Input Range is supported using Modernizr
          test: Modernizr.inputtypes.range,
          // If ranges are not supported, load the slider script and CSS file
          nope: [     
              // The slider CSS file
              './css/fd-slider.mhtml.min.css'       
              // The slider JS file
              ,'./js/fd-slider.js'     
          ],
          callback: function(id, testResult) {
              // If the slider file has loaded then fire the onDomReady event        
              if("fdSlider" in window && typeof (fdSlider.onDomReady) != "undefined") {
                  try { fdSlider.onDomReady(); } catch(err) {};
              };
          }
      }
      ]);      
            
      $(document).ready(function() {
         $("#bam-url").tokenInput([
               { name: "ACB" },
               { name: "ASW" },
               { name: "CDX" },
               { name: "CEU" },
               { name: "CHB" },
               { name: "CHD" },
               { name: "CLM" },
               { name: "FIN" },
               { name: "GBR" },
               { name: "GIH" },
               { name: "IBS" },
               { name: "JPT" },
               { name: "KHV" },
               { name: "LWK" },
               { name: "MXL" },
               { name: "PEL" },
               { name: "PUR" },
               { name: "TSI" },
               { name: "YRI" },
           ],  { 
              theme: "custom", 
              prePopulate : [{ name:'CEU'}, { name:'YRI'}, { name:'CHB'}],
              onAdd: function(elem) { addPop(elem); drawPopulation( window.region_hierachy ); },
              onDelete: function(elem) { removePop(elem); drawVcf( getPopulationArray() ); }
          });       
           
           // tmp do graph          
          
           var range = '1000000nt - 1050000nt';
           $("#range-nt").val(range);
           
//           var dataset = $('#bam-url').tokenInput("get");

            window.popTreeHeight = 600;
           var m = [20, 120, 20, 120],
               w = $("#graph-container").css('width').split('px')[0] - m[1] - m[3],
               h = window.popTreeHeight - m[0] - m[2];
               
            

           var svg = d3.select("#graph-container").append("svg:svg")
              .attr("width", '100%')
              .attr("height", "100%")
              .attr("id", "vcf-graph")

           createPopTree("js/region.json", svg,m, w, h, function() {getPcaGdsData();});
           
           // var w = $("#graph-container").css('width').split('px')[0],
           //     h = 400;
           //     
           // var svg = d3.select("#graph-container").append("svg")
           //     .attr("width", w)
           //     .attr("height", h)
           //     .attr("id", "vcf-graph");
                          
           //drawVcf( getPopulationArray() );
           // drawPopulation( window.region_hierachy );

// var svg1 = d3.select("#graph-container").append("svg")
//     .attr("width", 500)
//     .attr("height", 500)
//     .style("border", "1px solid green");

// svg.append("foreignObject").attr("width", 500).attr("height", 500).style("border", "1px solid red").append("xhtml:body").html("<input type=checkbox id=check />")
      });
      
      window.padding = 50;
      window.vcfBoxHeight = 50;
      window.x = [2.5,0.5,2.2,1.9,3.1,2.3,2,1,1.5,1.1];
      window.y = [2.4, 0.7,2.9,2.2,3.0,2.7,1.6,1.1,1.6,0.9];
      window.dotFillOp = $('.dot').css('fill-opacity');
      window.color = d3.scale.category10();
      

   </script>
   <script>
      function getChromosome() {return (11);}
      function getMin() {
         var range = $("#range-nt").val();
         // remove nt's and white space
         range = range.replace(/\s+|nt/g, '');
         // split min and max string and keep only min
         var min = range.split('-')[0];
         return parseInt(min);  
      };
      function getMax() {
         var range = $("#range-nt").val();
         // remove nt's and white space
         range = range.replace(/\s+|nt/g, '');
         // split min and max string and keep only max
         var max = range.split('-')[1];
         return parseInt(max);  
      };
      function getVcfBoxWidth() { 
         var w = d3.select('#vcf-graph').attr('width');
         var dl = $('#bam-url').tokenInput("get").length;
         return w / dl - window.padding;
      }
      function addPop(elem) {
         elem.active = true;         
         getPopulationArray().push(elem);
      }
      
      function removePop(elem) {
         window.populationArray = _.reject(getPopulationArray(), function(p) { return p.name == elem.name; });
      }
      
      function getPopulationArray() {
         if (window.populationArray) return window.populationArray;
         
         var pops = $('#bam-url').tokenInput("get");
          // add 'active' attribute to each population object
         window.populationArray = _.map( pops, function(elem) { elem.active = true; return elem; });
         return window.populationArray;
      }
      // function getBams() {
      //    var bamGroups = _.filter(getPopulationArray(), function(b){ return b.active; });
      //    var numFiles = 4;
      //    window.population = [];
      //    var bams = [];
      //    for ( var i=0; i < bamGroups.length; i++) {
      //       var files = _.filter(window.alignments, function(elem) { 
      //          if ( elem.indexOf('chrom'+getChromosome()) == -1 ) return false;
      //          if ( elem.indexOf(bamGroups[i].name)  != -1 ) return true; 
      //       });
      //       bams = bams.concat( files.slice(0,numFiles) );
      //       for( var j=0; j< numFiles; j++) window.population.push( bamGroups[i].name );
      //    }         
      //    return bams;
      // }
      // function getBamDataUrl() {
      //      var bams = getBams();
      //      var url = "http://0.0.0.0:8030?cmd="
      //      // for (var i=0; i < bams.length; i++) {
      //      //    url += " -in <(samtools view -u " + bams[i] + " 11:108473-189473)"
      //      // }
      //      url += getChromosome() + ":" + getMin() + "-" + getMax();
      //      for (var i=0; i < bams.length; i++) {
      //         url += " '" + bams[i] + "'";
      //      }
      //      
      //      return encodeURI(url);
      //   }
      
      function getStaticVcfUrl() {
         var vcf = "-h 'http://s3.amazonaws.com/1000genomes/release/20101123/interim_phase1_release/ALL.chr2.phase1.projectConsensus.genotypes.vcf.gz'";
         var url = "http://0.0.0.0:7090?cmd=" + vcf + " "
                 + "2:" + getMin() + "-" + getMax();
                 
         return encodeURI(url);
      }
      
      function getActiveVcfs() {
         var limit = 50;
         var vcfsToKeep = "";
         var activePopArrays = d3.selectAll("g .pop").filter(function(d) { return !d._vcf; }).data();
         var activePops = _.pluck(activePopArrays, 'name');

         _.each(activePops, function(pop) { 
            vcfsToKeep += window.pop2id[pop].slice(0,limit).join(' ') + ' '; 
         });
         
         return vcfsToKeep.trim();
      }
      
      function getVcfKeepUrl() {
         var url = 'http://0.0.0.0:7080?cmd= '
                 + getStaticVcfUrl() + ' '
                 + getActiveVcfs();

         return encodeURI(url);
      }
      
      function getStaticVcfData() {
        // var url = getVcfKeepUrl() + "&format=json&parseByLine=true";
         var url = getStaticVcfUrl() + "&format=json&parseByLine=true";
         var socket = io.connect(url);
         var samples = undefined;
         var variants = {};
         var i=0;
         var w = parseInt(d3.select("#vcf-graph rect").attr("width"));
         var x = d3.scale.linear()
             .domain([getMin(), getMax()])
             .range([2, w-2]);            
         
         socket.on('results', function(res) {
            var results = JSON.parse(res.data);
            if (results.length == 0) return;  

            // get samples
            if (results.header != undefined)
               samples = results.header.samples;
            
            // process genotypes
            if(results.data != undefined) {
               i+= 1;
               for( var j=0; j < results.data.genotypes.length; j++) {
                  var geno = results.data.genotypes[j];
                  if( geno[0] != 0 || geno[2] != 0) {
                     var pop = window.test_populations[ samples[j] ];
                     // var group = d3.select("#" + pop + "-vcf-graph");
                     if ( variants[pop] == undefined ) variants[pop] = [];
                     variants[pop].push( parseInt(results.data.pos) );
                  }
               }
               if ( (i % 400) == 0) updateVcf(variants, w, x);
            }
            
         });
         socket.on('end', function() {
            updateVcf(variants, w, x);
            
         })
         socket.emit('run', { 'url' : url })
      }
      
      function updateVcf(variants, w, x) {
         _.each(variants, function(varData, pop) {
            var group = d3.select("#" + pop + "-vcf-graph");

            // Generate a histogram using twenty uniformly-spaced bins.
            var data = d3.layout.histogram()
                .bins(x.ticks(20))
                (varData);
             
            var y = d3.scale.linear()
               .domain([0, d3.max(data, function(d) { return d.y; })])
               .range([0, 48]);    
         
            var bar = group.selectAll(".bar")
                .data(data)
           
            var barEnter = bar.enter().append("g")
                .attr("class", "bar")
                .attr("transform", function(d) { return "translate(" + parseInt(x(d.x) - w/2) + "," + 10 + ")"; });
             
            barEnter.append("rect")
              .attr("x", 1)
              .attr("width", w / data.length - 3)
              .attr("height", 0 )
              .style("fill", window.color(pop))
              .style("stroke", "none");
           
           
            var barUpdate = bar.transition()
                         .duration(2000);
                      
             barUpdate.select("rect")
                .attr("height", function(d) { return y(d.y); });

                     
            // bar.append("text")
            //   .attr("dy", ".75em")
            //   .attr("y", 6)
            //   .attr("x", x(data[0].dx) / 2)
            //   .attr("text-anchor", "middle")
            //   .text(function(d) { return formatCount(d.y); });
         });
      }
      
      function getSampleIdList() {
         // var samples = _.map(getBams(), function(b) { return b.match(/data\/(\S+)\/alignment/)[1]; });
         var activePops = d3.selectAll("g .pop").filter(function(d) { return !d._vcf; }).data();
         var pops
         return samples
      }
      
      function getPcaGdsName() {
         // var name = "http://0.0.0.0:8080?cmd=-f /Users/chase/Tools/freebayes/data/hs_ref_chr"
         //                   + getChromosome() + ".fa "
         //                   + _.pluck($('#bam-url').tokenInput("get"), "name").sort().join(" ");
         
         return  'chr' + getChromosome() + '_' + getMin() + '-' + getMax() + ".gds";
      }
      
      function getPcaGdsUrl() {
         var url = "http://0.0.0.0:8000?cmd="
                 + getPcaGdsName() + " "
                 + $("#ld-slider").val() + " "
                 + $("#maf-slider").val() + " "
                 + getActiveVcfs()
                 + "&format=json"
                 + "&parseByLine=true";
         return encodeURI(url);
      }
      
      function getPcaGdsData() {
         var url = getPcaGdsUrl();
         var socket = io.connect(url);
         socket.on('results', function(res){
            var results = JSON.parse(res.data);
            updatePcaChart(results, 750);
            
         });
         socket.emit('run', { 'url' : url })
      }
      
      function getPcaUrl() {
         var gds = getPcaGdsName();
         var url = "http://0.0.0.0:8010?cmd=stdin " 
                 + gds + " " 
                 + $("#ld-slider").val() + " "
                 + $("#maf-slider").val() + " "
                 + getVcfKeepUrl()//getStaticVcfUrl() //
                 + "&format=json"
                 + "&parseByLine=true";
         return encodeURI(url);
      }
      
      
      function getPcaData() {
         var url = getPcaUrl();
         window.population = window.test_populations_array;
         var initData = _.map(window.test_populations, function(v,k) { 
            return [0,0,k,v]; 
         });
         initPcaChart(initData);
         var socket = io.connect(url);
         socket.on('results', function(res) {
            var results = JSON.parse(res.data);
            updatePcaChart(results, 10000);
         });
         socket.on('end', function() {
            d3.selectAll(".dot").style("fill-opacity", 1);
            window.dotFillOp = '1';
         });
         socket.emit('run', { 'url' : url })
      }
      
      function updatePcaChart(data, duration) {
         var margin = {top: 20, right: 20, bottom: 30, left: 40},
             width = 960 - margin.left - margin.right,
             height = 500 - margin.top - margin.bottom;

         var x = d3.scale.linear()
             .range([-window.pcaBoxW/2 + 5,  window.pcaBoxW/2 - 5]);

         var y = d3.scale.linear()
             .range([$("#vcf-graph").height()/2 * 0.8 - 5, 5]);
             
         
         x.domain( [d3.min(data, function(d) {return d[0]}), d3.max(data, function(d) {return d[0]})] );
         y.domain( [d3.min(data, function(d) {return d[1]}), d3.max(data, function(d) {return d[1]})] );
         
         // filter data for null values and newlines
         for( var i=0; i < data.length; i++) {
            // check id for trainling newline
            if(data[i][2][ data[i][2].length-1 ] == "\n")
               data[i][2] = data[i][2].trim();
            else if (data[i][2] == "") {
               data.splice(i,1)
               i -= 1;
            }            
         }
             
         var dots = d3.select("#g-pca").selectAll(".dot");
         var dotData = dots.data(data, function(d) { return d[2]; });
         
         dotData.enter().append("circle")
            .attr("class", 'dot')
            .attr("cx", function(d) { return x(d[0]); })
            .attr("cy", function(d) { return y(d[1]); })
            .attr("r", 3.5)
            .style("fill-opacity", 1)
            .style("fill", function(d) { return window.color( window.region[ window.test_populations[d[2]] ]); });

         
         dots.transition()
            .ease("linear")
            .duration(duration)
            .attr("cx", function(d,i) { return x(d[0]); })
            .attr("cy", function(d) { return y(d[1]); });
         
         
         // dots.transition()
         //    .ease("bounce")
         //    .attr("r", 3.5);
         //.style("fill", function(d) { return window.color(d[2]); })
        // .each("end", function() { $('.dot').css('fill-opacity', window.dotFillOp); });
        
        dotData.exit().remove();
      }
      
      function initPcaChart(data) {
         var margin = {top: 20, right: 20, bottom: 30, left: 40},
             width = 960 - margin.left - margin.right,
             height = 500 - margin.top - margin.bottom;

         var x = d3.scale.linear()
             .range([-window.pcaBoxW/2,  window.pcaBoxW/2]);

         var y = d3.scale.linear()
             .range([$("#vcf-graph").height()/2 * 0.8 - 5, 0]);

         var xAxis = d3.svg.axis()
             .scale(x)
             .orient("bottom");

         var yAxis = d3.svg.axis()
             .scale(y)
             .orient("left");
             
             var div = d3.select("body").append("div")   
                 .attr("class", "tooltip")               
                 .style("opacity", 0);
         var svg = d3.select('#g-pca');

           x.domain( [-0.1, 0.1]);
           y.domain( [-0.1, 0.1]);
      
           svg.selectAll(".dot")
               .data(data, function(d) { return d[2]; })
             .enter().append("circle")
               .attr("class", "dot")
               .attr("r", 3.5)
               .attr("cx", function(d) { return x(d[0]); })
               .attr("cy", function(d) { return y(d[1]); })
               .style("fill", function(d) { return window.color( window.region[d[3]]); }) 
               .on("mouseover", function(d) {      
                           div.transition()        
                               .duration(100)      
                               .style("opacity", .9);      
                           div .html("Sample: " + d[2] + " Region: " + d[3])                                  
                               .style("left", (d3.event.pageX) + "px")     
                               .style("top", (d3.event.pageY - 24) + "px");    
                           })                  
                       .on("mouseout", function(d) {       
                           div.transition()        
                               .duration(500)      
                               .style("opacity", 0);   
                       });                          

           var legend = svg.selectAll(".legend")
               .data(window.color.domain())
             .enter().append("g")
               .attr("class", "legend")
               .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

           legend.append("rect")
               .attr("x", window.pcaBoxW/2 - 24)
               .attr("width", 18)
               .attr("height", 18)
               .attr('y', 5)
               .style("fill", window.color);

           legend.append("text")
               .attr("x", window.pcaBoxW/2 - 30)
               .attr("y", 14)
               .attr("dy", ".35em")
               .style("text-anchor", "end")
               .text(function(d) { return d; });
         
      }
       function toggleVcf(elem) {
          var pop = elem.getAttribute('data-name');
          var groups = getPopulationArray();
          //window.color = d3.scale.category10();
          // var group = undefined;
          // for ( var i=0; i < groups.length; i++) {
          //    if ( groups[i].name == pop ) {
          //       group = group[i];
          //       break;
          //    }
          //    // burn off groups so color scale
          //    color(groups[i].name);
          // }
          var group = _.find(groups, function(group) { return group.name == pop; });
          
          group.active = elem.checked;
          
         
          
          // d3.selectAll(".vcf-viz").selectAll("circle")
          //   .transition()
          //      .duration(750)
          //      .style("fill", function(d) {
          //         var c = color(this.parentElement.__data__.name);
          //         if (pop == this.parentElement.__data__.name) {
          //            if (this.parentElement.__data__.active) 
          //               return c;
          //            else 
          //               return 'rgb(200,200,200)';
          //         }
          //      })
          var groupD3 = d3.select("#" + pop + "-vcf-graph");
          groupD3.selectAll("circle")
            .transition()
               .duration(750)
               .style("fill", function(d) { 
                  if(group.active) 
                     return window.color(pop); 
                  else 
                  return 'rgb(200,200,200)'; 
               });
          
          //update pca
          getPcaGdsData();
       }
       
       function forceRedraw(element){

           if (!element) { return; }

           var n = document.createTextNode(' ');
           var disp = element.style.display;  // don't worry about previous display style

           element.appendChild(n);
           element.style.display = 'none';

           setTimeout(function(){
               element.style.display = disp;
               n.parentNode.removeChild(n);
           },20); // you can play with this timeout to make it as short as possible
       }
       
       function drawPopulation(dataset) {
          var padding = window.padding;         
          var svg = d3.select('#vcf-graph');
          var w = svg.attr('width');
          var h = svg.attr('height');
          window.h = h;
          var boxW = w/dataset.length;       
           var box = svg.selectAll(".vcf-viz")
                   .data(dataset, function(d) { return d.name; });

             // update data
             box.select(".vcf-viz g")
                .transition()
                   .duration(750)
                   .attr("transform", function(d,i) { return "translate(" + parseInt(i * (w / dataset.length) + padding/2) + "," + h/2 + ")"; });

             box.select(".vcf-viz rect")
                .transition()
                   .duration(750)
                   .attr('width', w / dataset.length - padding);

             var diagonal = d3.svg.diagonal();                                
             box.select(".vcf-viz path")
                .transition()
                   .duration(750)
                   .attr('d', function(d,i) { return diagonal({source:{x:w/2,y:0}, target:{x:i*boxW+padding/2+(boxW-padding)/2, y:h/2}}) } );               


             var x = d3.scale.linear()
                .range([0, getVcfBoxWidth()])
                .domain([getMin(), getMax()]);

             box.selectAll(".vcf-viz circle")
                .transition()
                   .duration(750)
                   .attr('cx', function(d) { return x(d); });

             // enter new data

             var g = box.enter().append("g")
                .attr("class", "vcf-viz")

             var gRegion = g.append("g")
                .attr('id', function(d) { return d.name + "-vcf-graph"; })
                .attr("transform", function(d,i) { return "translate(" + w/2 +  ",1)"; })


             gRegion.append("text")
                .attr('x', +1)
                .attr('y', -6)
                .style('text-anchor', 'middle')
                .text( function(d) { return d.name; })


             // gRegion.append("foreignObject")
             //       .attr("width", 50)
             //       .attr("height", 50)
             //       .attr("x", 0)
             //       .attr("y", -19)
             //       .attr("id", function(d) { return d.name + '-check';})
             //     .append("xhtml:input")
             //      .attr("type", 'checkbox')
             //      .attr("checked", true)
             //      .style("position", "static")
             //      .attr("onClick", 'toggleVcf(this)')
             //      .attr("data-name", function(d) { return d.name;})
             //      .on("click", function(d, i){ 
             //         // have to force redraw b\c of some bug with foreign objects and transforms       
             //         forceRedraw(this);
             //       });

             var circle = gRegion.append("circle")
                .attr('cx', 0)
                .attr('cy', 0)
                .attr('r', 0)
                .style("stroke", 'rgb(90,90,90)')
                .style("stroke-width", 2)
                .style("fill", "none")
                
            
             circle.transition()
                   .duration(750)
                   .attr("r", 3)

             gRegion.transition()
                .duration(750)
                .attr("transform", function(d,i) { return "translate(" + parseInt(i * (w / dataset.length) + padding/2) + "," + 20 + ")"; })


             // g.append('path')                  
             //                .style('stroke',  "rgb(100,100,100)")
             //                .style('stroke-width', '2px')
             //                .style('fill', 'none')
             //                .attr('d', function(d,i) { return diagonal({source:{x:w/2,y:0}, target:{x:w/2,y:0}}) } )
             //             .transition()
             //                .duration(750)
             //                .attr('d', function(d,i) { return diagonal({source:{x:w/2,y:0}, target:{x:i*boxW+padding/2+(boxW-padding)/2, y:h/2}}) } )

             // remove exiting data

             var gExit = box.exit();

             gExit.selectAll("path")
                .transition()
                   .duration(750)
                   .attr('d', function(d,i) { return diagonal({source:{x:w/2,y:0}, target:{x:w/2,y:0}}) } )
                   .remove();
             gExit.selectAll(".vcf-viz g")
                .transition()
                   .duration(750)
                   .attr("transform", function(d,i) { return "translate(" + w/2 +  ",0)"; })
                   .remove();
             gExit.selectAll("rect")
                .transition()
                   .duration(750)
                   .attr('width', 0)
                   .attr('height', 0)                                     
                   .remove();
             gExit
                .transition()
                   .delay(750)
                   .remove();
 
       }
       
       function drawVcf(dataset) {
         var padding = window.padding;         
         var svg = d3.select('#vcf-graph');
         var w = svg.attr('width');
         var h = svg.attr('height');
         window.h = h;
         var boxW = w/dataset.length;       

         var box = svg.selectAll(".vcf-viz")
               .data(dataset, function(d) { return d.name; });
               
         // update data
         box.select(".vcf-viz g")
            .transition()
               .duration(750)
               .attr("transform", function(d,i) { return "translate(" + parseInt(i * (w / dataset.length) + padding/2) + "," + h/2 + ")"; });
               
         box.select(".vcf-viz rect")
            .transition()
               .duration(750)
               .attr('width', w / dataset.length - padding);
                              
         var diagonal = d3.svg.diagonal();                                
         box.select(".vcf-viz path")
            .transition()
               .duration(750)
               .attr('d', function(d,i) { return diagonal({source:{x:w/2,y:0}, target:{x:i*boxW+padding/2+(boxW-padding)/2, y:h/2}}) } );               

         
         var x = d3.scale.linear()
            .range([0, getVcfBoxWidth()])
            .domain([getMin(), getMax()]);
         
         box.selectAll(".vcf-viz circle")
            .transition()
               .duration(750)
               .attr('cx', function(d) { return x(d); });
               
         // enter new data
         
         var g = box.enter().append("g")
            .attr("class", "vcf-viz")
            
         var gRect = g.append("g")
            .attr('id', function(d) { return d.name + "-vcf-graph"; })
            .attr("transform", function(d,i) { return "translate(" + w/2 +  ",0)"; })
      
         
         gRect.append("text")
            .attr('x', 18)
            .attr('y', -2)
            .text( function(d) { return d.name; })
            
         
         gRect.append("foreignObject")
               .attr("width", 50)
               .attr("height", 50)
               .attr("x", 0)
               .attr("y", -19)
               .attr("id", function(d) { return d.name + '-check';})
             .append("xhtml:input")
              .attr("type", 'checkbox')
              .attr("checked", true)
              .style("position", "static")
              .attr("onClick", 'toggleVcf(this)')
              .attr("data-name", function(d) { return d.name;})
              .on("click", function(d, i){ 
                 // have to force redraw b\c of some bug with foreign objects and transforms       
                 forceRedraw(this);
               });
         
         gRect.append("rect")
            .attr('x', 0)
            .attr('y', 0)
            .attr('width', 0)
            .attr('height', 0)
            .style("stroke", 'black')
            .style("fill", "none")
            .transition()
               .duration(750)
               .attr('width', w / dataset.length - padding)
               .attr('height', window.vcfBoxHeight);                  
   
         gRect.transition()
            .duration(750)
            .attr("transform", function(d,i) { return "translate(" + parseInt(i * (w / dataset.length) + padding/2) + "," + h/2 + ")"; })


         g.append('path')                  
               .style('stroke',  "rgb(100,100,100)")
               .style('stroke-width', '2px')
               .style('fill', 'none')
               .attr('d', function(d,i) { return diagonal({source:{x:w/2,y:0}, target:{x:w/2,y:0}}) } )
            .transition()
               .duration(750)
               .attr('d', function(d,i) { return diagonal({source:{x:w/2,y:0}, target:{x:i*boxW+padding/2+(boxW-padding)/2, y:h/2}}) } )
         
         // remove exiting data
         
         var gExit = box.exit();
         
         gExit.selectAll("path")
            .transition()
               .duration(750)
               .attr('d', function(d,i) { return diagonal({source:{x:w/2,y:0}, target:{x:w/2,y:0}}) } )
               .remove();
         gExit.selectAll(".vcf-viz g")
            .transition()
               .duration(750)
               .attr("transform", function(d,i) { return "translate(" + w/2 +  ",0)"; })
               .remove();
         gExit.selectAll("rect")
            .transition()
               .duration(750)
               .attr('width', 0)
               .attr('height', 0)                                     
               .remove();
         gExit
            .transition()
               .delay(750)
               .remove();
      }
      
      function startPca() {
         step2();
         
         // get VCF data
         getStaticVcfData();
         
         // fire PCA
         getPcaData();

      }
      
      function step2() {         
         // step 1 hide controls
         // $(".step1-sub-steps").slideUp("slow");         
         // 
         // $(".step1").css("color", "rgb(180,180,180)")
         // $(".step2").css("color", "black")
         // $(".step2-sub-steps").slideDown("slow"); 
         $("#pca-settings").css('visibility', 'visible');
         $("#pca-button").css('visibility', 'hidden');
          
         var origH = 600
        // $("#vcf-graph").css("height", $("#app").css("height"));
         
         var svgW = $("#vcf-graph").width();
         var svgH = $("#vcf-graph").height();
         window.pcaBoxW = svgW - 220;
         var boxH =  (svgH / 2) * 0.95;
         var padding = 5;
         
         var svg = d3.select("#vcf-graph");
         
         if( $("#g-pca").length == 0) {
         
            var g = svg.append("g")
               .attr("id", "g-pca")
               .attr("transform", 'translate(' + parseInt(svgW/2) + ',' + parseInt(0) + ')');
            
            // g.append("foreignObject")
            //     .attr("width", window.pcaBoxW)
            //     .attr("height", 100)
            //     .attr("x", -window.pcaBoxW/2)
            //     .attr("y", -20)
            //     .style("z-index", 10)
            //   .append("xhtml:body")
            //     .html('<div style="z-index:15; width: 500px; margin-left: auto; margin-right: auto; font-size:12px"><div style="float:left; width:76px;text-align:right">Some thing</div><input onClick="alert(10)" type="range" min="-10" max="10" step="0.20"  style="float:left"/><div style="float:right; width:76px;text-align:left">LD threshold</div><input type="range" min="0" max="100" style="float:right"/><div style="clear:both"></div></div>');
            
            var gr = g.append('rect')
               .attr('x', 0)
               .attr('y', 0)
               .style("stroke", 'black')
               .style("fill", "none")
               .attr('width', 0)
               .attr('height', 0);
            } else {
               var g = d3.select("#g-pca");
               var gr = g.select("rect");
            }
         
         
//         document.getElementById('fo-pca-sliders').style.display = 'block';   
         g.transition()
            .duration(750)
            .attr('transform', 'translate(' + parseInt(svgW/2) + ',' + parseInt(svgH/2) + ')');
            
         gr.transition()
            .duration(750)
            .attr('x', -window.pcaBoxW/2)
            .attr('width', window.pcaBoxW)
            .attr('height', boxH);
            
         g.selectAll('.dot')
            .transition()
               .duration(750)
               .attr('r', 3.5)
         
         var diagonal = d3.svg.diagonal();                                
      
         // var vBoxW = 50;
         // var vpadding = window.padding;
         // 
         // svg.selectAll(".lower-path")
         //    .transition()
         //       .duration(750)
         //       .attr('d', function(d,i) { return diagonal({source:{x:i*vBoxW + vBoxW/2 + vpadding/2 + i*(vpadding), y:origH/2 + window.vcfBoxHeight}, target:{x:svgW/2,y:svgH-boxH-padding}}) });
         // 
         // svg.selectAll(".lower-path")
         //       .data( getPopulationArray() )
         //    .enter().append("path")
         //       .attr("class", "lower-path")
         //       .style('stroke',  "rgb(100,100,100)")
         //       .style('stroke-width', '2px')
         //       .style("fill", "none")
         //       .attr('d', function(d,i) { return diagonal({source:{x:i*vBoxW + vBoxW/2 + vpadding/2 + i*(vpadding), y:origH/2 + window.vcfBoxHeight}, target:{x:i*vBoxW + vBoxW/2 + vpadding/2 + i*(vpadding), y:origH/2 + window.vcfBoxHeight}}) })
         //       .transition()
         //          .duration(750)
         //          .attr('d', function(d,i) { return diagonal({source:{x:i*vBoxW + vBoxW/2 + vpadding/2 + i*(vpadding), y:origH/2 + window.vcfBoxHeight}, target:{x:svgW/2,y:svgH-boxH-padding}}) });
            
         
      }
      
      function step1() {
         $(".step2-sub-steps").slideUp("slow");         
         
         $(".step2").css("color", "rgb(180,180,180)")
         $(".step1").css("color", "black")         
         $(".step1-sub-steps").slideDown("slow");  
         
         d3.select("#g-pca").select("rect")
            .transition()
               .duration(750)
               .attr('x', 0)
               .attr('width', 0)
               .attr('height', 0);
         
         d3.select("#g-pca")
            .transition()
               .duration(750)
               .attr("transform", 'translate(' + parseInt($("#vcf-graph").width()/2) + ',' + parseInt(window.h/2 + window.vcfBoxHeight) + ')')
               
         d3.select("#g-pca").selectAll(".dot")
            .transition()
               .duration(750)
               .attr('r', 0)
               
         d3.selectAll(".lower-path").remove();

         var diagonal = d3.svg.diagonal();
         var vBoxW = getVcfBoxWidth();
         var vpadding = window.padding;
         d3.selectAll('.lower-path')
            .transition()
               .duration(750)
               .attr('d', function(d,i) { return diagonal({source:{x:i*vBoxW + vBoxW/2 + vpadding/2 + i*(vpadding), y:window.h/2 + window.vcfBoxHeight}, target:{x:i*vBoxW + vBoxW/2 + vpadding/2 + i*(vpadding), y:window.h/2 + window.vcfBoxHeight}}) })
      }
      
   </script>
</head>

<body>
   
   <div id="app" style="position:absolute; left:0px; top:0px; bottom:0px; right:0px">
      <div id="title" >
         PCA<span style="color:#f36a22">gr</span>
         <div id="subtitle">1000G realtime principal <span style="letter-spacing:2px">component analysis</span></div>

      </div>
      <div id="step1-controls" class="step1-sub-steps" style="margin-top: 20px">
         <div style="position:relative; width: 400px; margin-left: auto; margin-right: auto">            
            <select id="chromosome" style="width:65px; position:absolute; top: 5px; left: 0px">
              <option value="1">Chr1</option>
              <option value="2">Chr2</option>
              <option value="3">Chr3</option>
              <option value="4">Chr4</option>
              <option value="5">Chr5</option>
              <option value="6">Chr6</option>
              <option value="7">Chr7</option>
              <option value="8">Chr8</option>
              <option value="9">Chr9</option>
              <option value="10">Chr10</option>
              <option value="11">Chr11</option>
              <option value="12">Chr12</option>
              <option value="13">Chr13</option>
              <option value="14">Chr14</option>
              <option value="15">Chr15</option>
              <option value="16">Chr16</option>
              <option value="17">Chr17</option>
              <option value="18">Chr18</option>
              <option value="19">Chr19</option>
              <option value="20">Chr20</option>
              <option value="21">Chr21</option>
              <option value="22">Chr22</option>
              <option value="x">ChrX</option>
              <option value="y">ChrY</option>
            </select>
            <div style="width:150px; position:absolute; top: 6px; left: 80px">1000G VCF</div>
            <input id="range-nt" class="nt-range" type="text"  style="width:150px; position:absolute; top: 5px; left: 180px"/>
         </div>
         <!-- <div id="sliders-freebayes" style="position:relative; width: 400px; margin-left: auto; margin-right: auto;">
            <input type="range" min="-10" max="10" step="0.20"  style="position:absolute; top: 5px; left: 0px"/>
            <input type='range' min="0" max="100" style="position:absolute; top: 5px; right: 0px; height: 10px"/>
            <input type="range" min="-10" max="10" step="0.20"  style="position:absolute; top: 25px; left: 0px"/>
            <input type='range' min="0" max="100" style="position:absolute; top: 25px; right: 0px"/>
         </div> -->
      </div>      
      <div id="graph-container"></div>
      <div id="pca-button" onClick="startPca()" style=" height:60px; border-radius:44px; border: 1px solid rgb(180,180,180);text-align:center; line-height: 55px; background-color: #990E00; color: white; font-size: 40px; cursor:pointer; position:absolute; top:60%; left:50%; margin-left:-200px; width: 400px">Start PCA</div>
      <div id="pca-settings" style="position:absolute; margin-left:-250px; left:50%; top:49% ;width:500px; visibility:hidden">
         <span style="position:absolute; top: 3px; left: 0px">MAF</span>
         <input id="maf-slider" onmouseup="getPcaGdsData()" value="0.03" type="range" min="0" max="0.1" step="0.01" style="position:absolute; top: 5px; left: 34px"/>
         <input id="ld-slider" onmouseup="getPcaGdsData()" value="4" type='range' min="0" max="10" step="0.1" style="position:absolute; top: 5px; right: 28px; height: 10px"/>
         <span style="position:absolute; top: 2px; right: 0px">LD</span>
      </div>
            

   </div>
   <!-- <div id="steps" style="position:absolute; right:0px; top:0px; bottom:0px; left:78%">
           <div class="step step1" style="margin-top: 20px">
              <h1 onClick="step1()">1. Choose</h1>
              <div class="step1-sub-steps">
                  <div style=" margin-top:25px; margin-left: -220px; margin-bottom: -36px"><-------------------------------</div>
                  <div class="sub-step">Choose 1000G Populations<img src="images/info.png"/ style="height:20px; vertical-align:text-bottom"/></div>
                  <div style=" margin-top:35px; margin-left: -220px; margin-bottom: -36px"><-------------------------------</div>
                 <div class="sub-step">Set Variant Calling Params<img src="images/info.png"/ style="height:20px; vertical-align:text-bottom"/></div>
                       <div id="pca-button" onClick="startPca()" style="margin-left: 20px; margin-right: 20px; margin-top: 30px; height:30px; border-radius:44px; border: 1px solid rgb(180,180,180);text-align:center; line-height: 30px; background-color: #990E00; color: white; font-size: 20px; cursor:pointer">Start PCA</div>
              </div>
           </div>
           <div class="step step2" style="margin-top: 248px; color: rgb(180,180,180)">
              <h1 onClick="step2();">2. Play</h2>
                 <div class="step2-sub-steps" style="display: none">
                    <div style=" margin-top:25px; margin-left: -220px; margin-bottom: -36px"><-------------------------------</div>  
                    <div class="sub-step">Play with PCA Params<img src="images/info.png"/ style="height:20px; vertical-align:text-bottom"/></div>
                    <div  style="position:relative; width: 450px; margin-top: -37px; margin-left: -245%">
                       
                       <input id="maf-slider" onmouseup="getPcaGdsData()" value="0.03" type="range" min="0" max="0.1" step="0.01" style="position:absolute; top: 5px; left: 34px"/>
                       <input id="ld-slider" onmouseup="getPcaGdsData()" value="4" type='range' min="0" max="10" step="0.1" style="position:absolute; top: 5px; right: 28px; height: 10px"/>
                       <span style="position:absolute; top: 2px; right: 0px">LD</span>
                    </div>
                 </div>
           </div>
        </div> -->
   
   
</body>
</html>